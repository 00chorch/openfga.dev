"use strict";(self.webpackChunkopenfga_dev=self.webpackChunkopenfga_dev||[]).push([[6248],{25120:(e,t,a)=>{a.r(t),a.d(t,{assets:()=>s,contentTitle:()=>l,default:()=>m,frontMatter:()=>r,metadata:()=>o,toc:()=>p});var n=a(87462),i=(a(67294),a(3905));const r={title:"Conditional Relationship Tuples for OpenFGA",description:"Conditional Relationship Tuples for OpenFGA",slug:"conditional-tuples-announcement",date:new Date("2023-11-06T00:00:00.000Z"),authors:"aaguiar",tags:["openfga","features"],image:"https://openfga.dev/img/openfga_logo.svg",hide_table_of_contents:!1},l="Release Candidate for OpenFGA Conditional Tuples",o={permalink:"/blog/conditional-tuples-announcement",source:"@site/blog/conditional-tuples-announcement.md",title:"Conditional Relationship Tuples for OpenFGA",description:"Conditional Relationship Tuples for OpenFGA",date:"2023-11-06T00:00:00.000Z",formattedDate:"November 6, 2023",tags:[{label:"openfga",permalink:"/blog/tags/openfga"},{label:"features",permalink:"/blog/tags/features"}],readingTime:4.445,hasTruncateMarker:!1,authors:[{name:"Andres Aguiar",title:"Product Manager",url:"https://github.com/aaguiarz",imageURL:"/img/blog/authors/andres.jpg",key:"aaguiar"}],frontMatter:{title:"Conditional Relationship Tuples for OpenFGA",description:"Conditional Relationship Tuples for OpenFGA",slug:"conditional-tuples-announcement",date:"2023-11-06T00:00:00.000Z",authors:"aaguiar",tags:["openfga","features"],image:"https://openfga.dev/img/openfga_logo.svg",hide_table_of_contents:!1},nextItem:{title:"Join the OpenFGA team at KubeCon NA 2023",permalink:"/blog/kubecon-na-2023"}},s={authorsImageUrls:[void 0]},p=[{value:"Use Cases",id:"use-cases",level:2},{value:"How to use it?",id:"how-to-use-it",level:2},{value:"What\u2019s Next?",id:"whats-next",level:2},{value:"Reach out!",id:"reach-out",level:2}],u={toc:p},d="wrapper";function m(e){let{components:t,...a}=e;return(0,i.kt)(d,(0,n.Z)({},u,a,{components:t,mdxType:"MDXLayout"}),(0,i.kt)("p",null,"Relationship Tuples are the facts that the OpenFGA evaluates to determine whether a user is permitted to access a resource."),(0,i.kt)("p",null,"The way tuples are considered when making authorization decisions in OpenFGA is guided by an authorization model, which employs concepts from Relationship-Based Access Control (ReBAC) to establish authorization policies. For instance, you might declare that users are allowed to view a document if they have permission to view its parent folder."),(0,i.kt)("p",null,"Although ReBAC offers a highly flexible method for structuring permissions, it encounters difficulties with defining permissions based on attributes that are not easily represented as relationships. Attributes such as \u201cparent folder,\u201d \u201cdepartment,\u201d \u201cregion,\u201d and \u201ccountry\u201d can be conceptualized as relationships between two entities. However, attributes like \u201cIP address,\u201d \u201ctime of day,\u201d \u201cteam size limit,\u201d or \u201cmaximum amount for a bank transfer\u201d cannot be easily handled."),(0,i.kt)("p",null,"In our ongoing efforts to expand OpenFGA\u2019s capacity for articulating a broader range of authorization policies, we are introducing ",(0,i.kt)("strong",{parentName:"p"},"Conditional Relationship Tuples"),". These allow for the specification of conditions under which a particular tuple is relevant when evaluating an authorization query."),(0,i.kt)("p",null,"Consider the following example, where we utilize Conditional Tuples to grant access for a user over a specified time duration. We stipulate that a user may be granted either unconditional access or access constrained to a certain time period:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-dsl.openfga"},"model\n  schema 1.1\n\ntype user\n\ntype document\n  relations\n    define viewer: [user, user with non_expired_grant]\n\ncondition non_expired_grant(current_time: timestamp, grant_time: timestamp, grant_duration: duration) {\n  current_time < grant_time + grant_duration\n}\n")),(0,i.kt)("p",null,"If we write the following tuples:"),(0,i.kt)("table",null,(0,i.kt)("thead",{parentName:"table"},(0,i.kt)("tr",{parentName:"thead"},(0,i.kt)("th",{parentName:"tr",align:null},"user"),(0,i.kt)("th",{parentName:"tr",align:null},"relation"),(0,i.kt)("th",{parentName:"tr",align:null},"object"),(0,i.kt)("th",{parentName:"tr",align:null},"condition"))),(0,i.kt)("tbody",{parentName:"table"},(0,i.kt)("tr",{parentName:"tbody"},(0,i.kt)("td",{parentName:"tr",align:null},"user:bob"),(0,i.kt)("td",{parentName:"tr",align:null},"viewer"),(0,i.kt)("td",{parentName:"tr",align:null},"document:1"),(0,i.kt)("td",{parentName:"tr",align:null})),(0,i.kt)("tr",{parentName:"tbody"},(0,i.kt)("td",{parentName:"tr",align:null},"user:anne"),(0,i.kt)("td",{parentName:"tr",align:null},"viewer"),(0,i.kt)("td",{parentName:"tr",align:null},"document:1"),(0,i.kt)("td",{parentName:"tr",align:null},(0,i.kt)("inlineCode",{parentName:"td"},"name")," : ",(0,i.kt)("inlineCode",{parentName:"td"},"non_expired_grant"),", ",(0,i.kt)("inlineCode",{parentName:"td"},"context")," : { ",(0,i.kt)("inlineCode",{parentName:"td"},"grant_time")," : ",(0,i.kt)("inlineCode",{parentName:"td"},"2023-01-01T00:00:00Z"),", ",(0,i.kt)("inlineCode",{parentName:"td"},"grant_duration")," : ",(0,i.kt)("inlineCode",{parentName:"td"},"1h")," }")))),(0,i.kt)("p",null,"You'll get the following results for the ",(0,i.kt)("a",{parentName:"p",href:"https://openfga.dev/api/service#/Relationship%20Queries/Check"},"Check")," operations below:"),(0,i.kt)("table",null,(0,i.kt)("thead",{parentName:"table"},(0,i.kt)("tr",{parentName:"thead"},(0,i.kt)("th",{parentName:"tr",align:null},"user"),(0,i.kt)("th",{parentName:"tr",align:null},"relation"),(0,i.kt)("th",{parentName:"tr",align:null},"object"),(0,i.kt)("th",{parentName:"tr",align:null},"context"),(0,i.kt)("th",{parentName:"tr",align:null},"result"))),(0,i.kt)("tbody",{parentName:"table"},(0,i.kt)("tr",{parentName:"tbody"},(0,i.kt)("td",{parentName:"tr",align:null},"user:bob"),(0,i.kt)("td",{parentName:"tr",align:null},"viewer"),(0,i.kt)("td",{parentName:"tr",align:null},"document:1"),(0,i.kt)("td",{parentName:"tr",align:null}),(0,i.kt)("td",{parentName:"tr",align:null},(0,i.kt)("inlineCode",{parentName:"td"},"allowed")," : ",(0,i.kt)("inlineCode",{parentName:"td"},"true"))),(0,i.kt)("tr",{parentName:"tbody"},(0,i.kt)("td",{parentName:"tr",align:null},"user:anne"),(0,i.kt)("td",{parentName:"tr",align:null},"viewer"),(0,i.kt)("td",{parentName:"tr",align:null},"document:1"),(0,i.kt)("td",{parentName:"tr",align:null},(0,i.kt)("inlineCode",{parentName:"td"},"current_time")," : ",(0,i.kt)("inlineCode",{parentName:"td"},"2023-01-01T00:10:00Z")),(0,i.kt)("td",{parentName:"tr",align:null},(0,i.kt)("inlineCode",{parentName:"td"},"allowed")," : ",(0,i.kt)("inlineCode",{parentName:"td"},"true"))),(0,i.kt)("tr",{parentName:"tbody"},(0,i.kt)("td",{parentName:"tr",align:null},"user:anne"),(0,i.kt)("td",{parentName:"tr",align:null},"viewer"),(0,i.kt)("td",{parentName:"tr",align:null},"document:1"),(0,i.kt)("td",{parentName:"tr",align:null},(0,i.kt)("inlineCode",{parentName:"td"},"current_time")," : ",(0,i.kt)("inlineCode",{parentName:"td"},"2023-01-01T02:00:00Z")),(0,i.kt)("td",{parentName:"tr",align:null},(0,i.kt)("inlineCode",{parentName:"td"},"allowed")," : ",(0,i.kt)("inlineCode",{parentName:"td"},"false"))),(0,i.kt)("tr",{parentName:"tbody"},(0,i.kt)("td",{parentName:"tr",align:null},"user:anne"),(0,i.kt)("td",{parentName:"tr",align:null},"viewer"),(0,i.kt)("td",{parentName:"tr",align:null},"document:1"),(0,i.kt)("td",{parentName:"tr",align:null}),(0,i.kt)("td",{parentName:"tr",align:null},(0,i.kt)("inlineCode",{parentName:"td"},"error")," : \"failed to evaluate relationship condition 'non_expired_grant': context is missing parameters '","[current_time]","'")))),(0,i.kt)("p",null,"You'll get the following results for the ",(0,i.kt)("a",{parentName:"p",href:"https://openfga.dev/api/service#/Relationship%20Queries/ListObjects"},"ListObjects")," operations below:"),(0,i.kt)("table",null,(0,i.kt)("thead",{parentName:"table"},(0,i.kt)("tr",{parentName:"thead"},(0,i.kt)("th",{parentName:"tr",align:null},"user"),(0,i.kt)("th",{parentName:"tr",align:null},"relation"),(0,i.kt)("th",{parentName:"tr",align:null},"object"),(0,i.kt)("th",{parentName:"tr",align:null},"context"),(0,i.kt)("th",{parentName:"tr",align:null},"result"))),(0,i.kt)("tbody",{parentName:"table"},(0,i.kt)("tr",{parentName:"tbody"},(0,i.kt)("td",{parentName:"tr",align:null},"user:anne"),(0,i.kt)("td",{parentName:"tr",align:null},"viewer"),(0,i.kt)("td",{parentName:"tr",align:null},"document:1"),(0,i.kt)("td",{parentName:"tr",align:null},(0,i.kt)("inlineCode",{parentName:"td"},"current_time")," : ",(0,i.kt)("inlineCode",{parentName:"td"},"2023-01-01T00:10:00Z")),(0,i.kt)("td",{parentName:"tr",align:null},(0,i.kt)("inlineCode",{parentName:"td"},"objects"),": ",(0,i.kt)("inlineCode",{parentName:"td"},'[ "document:1"]'))),(0,i.kt)("tr",{parentName:"tbody"},(0,i.kt)("td",{parentName:"tr",align:null},"user:anne"),(0,i.kt)("td",{parentName:"tr",align:null},"viewer"),(0,i.kt)("td",{parentName:"tr",align:null},"document:1"),(0,i.kt)("td",{parentName:"tr",align:null}),(0,i.kt)("td",{parentName:"tr",align:null},(0,i.kt)("inlineCode",{parentName:"td"},"error"),": \"failed to evaluate relationship condition 'non_expired_grant': tuple 'document:1#viewer@user:anne' is missing context parameters '","[current_time]","'")))),(0,i.kt)("p",null,"Note that:"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("inlineCode",{parentName:"li"},"user:bob")," will always get ",(0,i.kt)("inlineCode",{parentName:"li"},"allowed:true")," as we has assigned as as viewer unconditionally."),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("inlineCode",{parentName:"li"},"user:anne")," will get ",(0,i.kt)("inlineCode",{parentName:"li"},"allowed:true")," if the ",(0,i.kt)("inlineCode",{parentName:"li"},"current_time")," is before the ",(0,i.kt)("inlineCode",{parentName:"li"},"grant_time")," + ",(0,i.kt)("inlineCode",{parentName:"li"},"grant_duration")," and ",(0,i.kt)("inlineCode",{parentName:"li"},"allowed:false")," otherwise."),(0,i.kt)("li",{parentName:"ul"},"If you don't provide the ",(0,i.kt)("inlineCode",{parentName:"li"},"current_time")," in the context, the Check and ListObjects operations will fail.")),(0,i.kt)("h2",{id:"use-cases"},"Use Cases"),(0,i.kt)("p",null,"The ",(0,i.kt)("a",{parentName:"p",href:"https://github.com/openfga/sample-stores"},"OpenFGA Sample Stores repository")," has several examples that take advantage of this new feature:"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("a",{parentName:"li",href:"https://github.com/openfga/sample-stores/tree/main/stores/temporal-access"},"Granting access during a specific period of time (the use case explained above)"),"."),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("a",{parentName:"li",href:"https://github.com/openfga/sample-stores/tree/main/stores/ip-based-access"},"Allow access based on the user\u2019s IP Address"),"."),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("a",{parentName:"li",href:"https://github.com/openfga/sample-stores/tree/main/stores/groups-resource-attributes"},"Granting access based on group membership and resource attributes"),"."),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("a",{parentName:"li",href:"https://github.com/openfga/sample-stores/tree/main/stores/advanced-entitlements"},"Allow access to specific features based on usage"),"."),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("a",{parentName:"li",href:"https://github.com/openfga/sample-stores/tree/main/stores/banking"},"Determine if a user can make a bank transfer based .on the transaction amount"),"."),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("a",{parentName:"li",href:"https://github.com/openfga/sample-stores/tree/main/stores/condition-data-types"},"Data types and operations supported in conditions"),".")),(0,i.kt)("h2",{id:"how-to-use-it"},"How to use it?"),(0,i.kt)("p",null,"Conditional Relationship Tuples are included in OpenFGA 1.4.0-rc1 version. You can run it by pulling it from docker:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-shell"},"docker pull openfga/openfga:v1.4.0-rc1\ndocker run -p 8080:8080 -p 8081:8081 -p 3000:3000 openfga/openfga:v1.4.0-rc1 run`\n")),(0,i.kt)("p",null,"OpenFGA has a rich ecosystem of developer tools. The following have been updated to support Conditional Relationship Tuples:"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("p",{parentName:"li"},(0,i.kt)("a",{parentName:"p",href:"https://marketplace.visualstudio.com/items?itemName=openfga.openfga-vscode"},"Visual Studio Code integration")," which provides syntax highlighting and model validations for conditions.")),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("p",{parentName:"li"},"Beta versions of the ",(0,i.kt)("a",{parentName:"p",href:"https://www.npmjs.com/package/@openfga/sdk/v/0.3.0-beta.1"},"Javascript SDK")," and the ",(0,i.kt)("a",{parentName:"p",href:"https://github.com/openfga/go-sdk/releases/tag/v0.3.0-beta.1"},"Go SDK"),", which allows using the additional parameters.")),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("p",{parentName:"li"},"The ",(0,i.kt)("a",{parentName:"p",href:"https://github.com/openfga/cli"},"OpenFGA CLI")," allows validating models and runing tests that use conditional tuples. You can use it to test the new features by pointing to a ",(0,i.kt)("inlineCode",{parentName:"p"},"\u201c.fga.yaml\u201d")," file that ",(0,i.kt)("a",{parentName:"p",href:"https://github.com/openfga/cli#run-tests-on-an-authorization-model"},"defines the tests you want to run"),", without having to deploy OpenFGA."))),(0,i.kt)("h2",{id:"whats-next"},"What\u2019s Next?"),(0,i.kt)("p",null,"We\u2019ll address some limitations of the current implementation:"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},"The ",(0,i.kt)("a",{parentName:"li",href:"https://openfga.dev/api/service#/Relationship%20Queries/Expand"},"Expand API")," does not consider conditions."),(0,i.kt)("li",{parentName:"ul"},"The Visual Studio Code integration is not validating the expressions in conditions. ")),(0,i.kt)("p",null,"We'll also improve ListObjects scenarios when it's called with missing context.  For example, consider the following model that enables access only to documents with a specific status:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-dsl.openfga"},'model\n  schema 1.1\n\ntype user\n\ntype document\n  relations\n    define can_access: [user with docs_in_draft_status]\n\ncondition docs_in_draft_status(status: string) {\n  status == "draft"\n}\n')),(0,i.kt)("p",null,"If you want to list all the documents a user can view, you'll need to know the status of all of those documents. Given you don't know the documents the user has access too, you can't send the status of those as a parameter to ListObjects."),(0,i.kt)("p",null,"Our goal is to return a structure that you can use to filter documents on your side, similar to:\n",(0,i.kt)("inlineCode",{parentName:"p"},"(document.id = \u20181\u2019 and document.status = \u2018draft\u2019) or (document.id = \u20182\u2019 and.status = draft)")," ",(0,i.kt)("br",null),"\nThis won\u2019t scale to a large number of documents, but would be useful in some scenarios."),(0,i.kt)("h2",{id:"reach-out"},"Reach out!"),(0,i.kt)("p",null,"We want to learn how you use this feature and how we can improve it! "),(0,i.kt)("p",null,"Please reach out to us in ",(0,i.kt)("a",{parentName:"p",href:"https://discord.gg/8naAwJfWN6"},"Discord")," or ",(0,i.kt)("a",{parentName:"p",href:"https://github.com/orgs/openfga/discussions"},"Github")," with any questions or feedback."))}m.isMDXComponent=!0}}]);